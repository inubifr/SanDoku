<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einsatzdokumentation Sanit√§tsdienst SC Freiburg</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            color-scheme: light dark;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #f5f5f5;
                --bg-secondary: #ffffff;
                --bg-tertiary: #e8e8e8;
                --text-primary: #1a1a1a;
                --text-secondary: #666666;
                --text-tertiary: #999999;
                --border-color: #d0d0d0;
                --border-hover: #999999;
                --accent-red: #dc3545;
                --accent-red-hover: #c82333;
                --accent-orange: #fd7e14;
                --accent-yellow: #ffc107;
                --accent-green: #28a745;
                --accent-blue: #007bff;
                --accent-purple: #6f42c1;
                --accent-cyan: #17a2b8;
                --btn-secondary: #e0e0e0;
                --btn-secondary-hover: #d0d0d0;
                --entry-border: #d0d0d0;
                --entry-border-hover: #dc3545;
                --ktw-color: #17a2b8;
                --rtw-color: #dc3545;
                --nef-color: #ffc107;
                --naw-color: #6f42c1;
                --sonst-color: #6c757d;
                --sichtung-rot: #dc3545;
                --sichtung-gelb: #ffc107;
                --sichtung-gruen: #28a745;
                --status-entlassen: #6c757d;
                --section-header-bg: #1a1a1a;
                --section-header-text: #ffffff;
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2a2a2a;
                --bg-tertiary: #1a1a1a;
                --text-primary: #e0e0e0;
                --text-secondary: #999999;
                --text-tertiary: #666666;
                --border-color: #404040;
                --border-hover: #666666;
                --accent-red: #dc3545;
                --accent-red-hover: #c82333;
                --accent-orange: #fd7e14;
                --accent-yellow: #ffc107;
                --accent-green: #28a745;
                --accent-blue: #007bff;
                --accent-purple: #6f42c1;
                --accent-cyan: #17a2b8;
                --btn-secondary: #404040;
                --btn-secondary-hover: #505050;
                --entry-border: #404040;
                --entry-border-hover: #dc3545;
                --ktw-color: #17a2b8;
                --rtw-color: #dc3545;
                --nef-color: #ffc107;
                --naw-color: #6f42c1;
                --sonst-color: #6c757d;
                --sichtung-rot: #dc3545;
                --sichtung-gelb: #ffc107;
                --sichtung-gruen: #28a745;
                --status-entlassen: #6c757d;
                --section-header-bg: #dc3545;
                --section-header-text: #ffffff;
            }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-container {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .login-logo {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .login-logo .logo {
            height: 60px;
            width: 60px;
        }

        .login-title {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .login-functions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-login-function {
            padding: 20px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .btn-login-function:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .btn-login-function .icon {
            font-size: 28px;
        }

        .btn-login-function.einsatzleitung { border-color: var(--accent-red); }
        .btn-login-function.einsatzleitung:hover { background: var(--accent-red); color: white; }
        .btn-login-function.fuehrungsassistent { border-color: var(--accent-green); }
        .btn-login-function.fuehrungsassistent:hover { background: var(--accent-green); color: white; }
        .btn-login-function.mc1 { border-color: var(--accent-cyan); }
        .btn-login-function.mc1:hover { background: var(--accent-cyan); color: white; }
        .btn-login-function.mc2 { border-color: var(--accent-purple); }
        .btn-login-function.mc2:hover { background: var(--accent-purple); color: white; }

        /* Header mit Logos */
        header {
            background: var(--bg-secondary);
            padding: 15px 20px;
            border-bottom: 4px solid var(--accent-red);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            border-radius: 4px 4px 0 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            height: 50px;
            width: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            color: #333;
            font-size: 10px;
            border-radius: 50%;
            border: 1px solid #ddd;
        }
        
        .logo-sc { width: 50px; height: 50px; font-weight: bold; }
        .logo-drk { width: 50px; height: 50px; font-weight: bold; }

        h1 {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.2;
        }

        .user-info {
            background: var(--bg-tertiary);
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .user-function {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .btn-logout {
            padding: 5px 10px;
            background: var(--btn-secondary);
            color: var(--text-primary);
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .btn-logout:hover {
            background: var(--btn-secondary-hover);
        }

        .btn-end-mission {
            padding: 5px 10px;
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }

        .btn-end-mission:hover {
            background: var(--accent-red-hover);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-export {
            padding: 8px 16px;
            background: var(--btn-secondary);
            color: var(--text-primary);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .btn-export:hover {
            background: var(--btn-secondary-hover);
        }

        .btn-export.csv {
            background: var(--accent-green);
            color: white;
        }

        .btn-export.csv:hover {
            background: #218838;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 12px 24px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: none;
            border-radius: 2px 2px 0 0;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .tab-button:hover {
            color: var(--text-primary);
        }

        .tab-button.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-red);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: var(--bg-secondary);
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 2px;
        }

        /* Grid System */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .standard-messages-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .required::after {
            content: ' *';
            color: var(--accent-red);
        }

        input, select, textarea {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 12px;
            font-size: 14px;
            border-radius: 2px;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-red);
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .button-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .btn-send {
            background: var(--accent-red);
            color: white;
        }

        .btn-send:hover {
            background: var(--accent-red-hover);
        }

        .btn-clear {
            background: var(--btn-secondary);
            color: var(--text-primary);
        }

        .btn-clear:hover {
            background: var(--btn-secondary-hover);
        }

        /* Sichtungskategorien - GROSS */
        .sichtung-compact {
            display: flex;
            gap: 10px;
        }

        .btn-sichtung-compact {
            flex: 1;
            padding: 15px 8px;
            border: 3px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.2s;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .btn-sichtung-compact .icon {
            font-size: 24px;
        }

        .btn-sichtung-compact:hover {
            transform: translateY(-2px);
        }

        .btn-sichtung-compact.active {
            border-width: 4px;
        }

        .btn-sichtung-compact.sk1 { border-color: var(--sichtung-rot); }
        .btn-sichtung-compact.sk1.active { background: var(--sichtung-rot); color: white; }

        .btn-sichtung-compact.sk2 { border-color: var(--sichtung-gelb); }
        .btn-sichtung-compact.sk2.active { background: var(--sichtung-gelb); color: black; }

        .btn-sichtung-compact.sk3 { border-color: var(--sichtung-gruen); }
        .btn-sichtung-compact.sk3.active { background: var(--sichtung-gruen); color: white; }

        /* Kategorie Buttons - GROSS wie Sichtung */
        .kategorie-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-kategorie {
            flex: 1;
            padding: 15px 8px;
            border: 3px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.2s;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            text-align: center;
            min-width: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .btn-kategorie .icon {
            font-size: 20px;
        }

        .btn-kategorie:hover {
            transform: translateY(-2px);
            border-color: var(--accent-blue);
        }

        .btn-kategorie.active {
            border-color: var(--accent-blue);
            background: var(--accent-blue);
            color: white;
            border-width: 4px;
        }

        /* Geschlechts-Icons */
        .gender-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-gender {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            background: var(--bg-tertiary);
        }

        .btn-gender:hover {
            transform: translateY(-2px);
        }

        .btn-gender.active {
            border-color: var(--accent-blue);
            background: var(--accent-blue);
            color: white;
        }

        /* Verletztenstatus - GR√ñSSER */
        .verletztenstatus-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .btn-verletztenstatus {
            padding: 12px 8px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.2s;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-verletztenstatus:hover {
            transform: translateY(-2px);
            background: var(--bg-secondary);
        }

        .btn-verletztenstatus.active {
            border-width: 3px;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
        }

        .btn-verletztenstatus.active.sauerstoff { border-color: var(--accent-cyan); background: var(--accent-cyan); color: white; }
        .btn-verletztenstatus.active.monitor { border-color: var(--accent-blue); background: var(--accent-blue); color: white; }
        .btn-verletztenstatus.active.intubiert { border-color: var(--accent-purple); background: var(--accent-purple); color: white; }
        .btn-verletztenstatus.active.beatmet { border-color: var(--accent-orange); background: var(--accent-orange); color: white; }
        .btn-verletztenstatus.active.reanimiert { border-color: var(--accent-red); background: var(--accent-red); color: white; }

        .btn-verletztenstatus .icon {
            font-size: 28px;
            display: inline-block;
            line-height: 1;
        }

        /* NEUE Kompakte Sections mit besserer Optik */
        .compact-section {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .compact-section-header {
            background: var(--section-header-bg);
            color: var(--section-header-text);
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 3px solid var(--accent-red);
        }

        .compact-section-header .header-icon {
            font-size: 18px;
        }

        .compact-section-body {
            padding: 20px;
            background: var(--bg-tertiary);
        }

        /* ABCDE Beurteilung - Verbessert */
        .abcde-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .abcde-item {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .abcde-item:hover {
            border-color: var(--accent-red);
        }

        .abcde-item:focus-within {
            border-color: var(--accent-red);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
        }

        .abcde-letter {
            background: var(--accent-red);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: 800;
        }

        .abcde-letter.a { background: #dc3545; }
        .abcde-letter.b { background: #fd7e14; }
        .abcde-letter.c { background: #ffc107; color: #000; }
        .abcde-letter.d { background: #28a745; }
        .abcde-letter.e { background: #17a2b8; }

        .abcde-label {
            padding: 8px 10px;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .abcde-item select {
            width: 100%;
            border: none;
            border-radius: 0;
            padding: 12px 10px;
            font-size: 13px;
            background: var(--bg-secondary);
        }

        .abcde-item select:focus {
            outline: none;
            box-shadow: none;
        }

        /* Vitalwerte */
        .vitalwerte-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .vitalwert-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .vitalwert-header {
            background: var(--bg-tertiary);
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .vitalwert-body {
            padding: 12px;
        }

        .vitalwerte-input {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .vitalwerte-input input {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }

        .btn-add-vital {
            padding: 8px 12px;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            white-space: nowrap;
        }

        .btn-add-vital:hover {
            background: #218838;
        }

        .vital-history {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 80px;
            overflow-y: auto;
        }

        .vital-entry {
            background: var(--bg-tertiary);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--accent-blue);
        }

        .btn-delete-vital {
            background: transparent;
            color: var(--accent-red);
            border: none;
            cursor: pointer;
            padding: 0 4px;
            font-size: 16px;
            line-height: 1;
        }

        /* Adresse Section */
        .adresse-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr 1fr;
            gap: 12px;
        }

        /* Ressourcen-Verwaltung */
        .resource-add-section {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 2px;
        }

        .resource-add-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .resource-add-form .form-group {
            flex: 1;
        }

        .btn-add-resource {
            padding: 10px 20px;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .resource-type-section {
            margin-bottom: 25px;
        }

        .resource-type-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin-bottom: 12px;
        }

        .resource-type-header.ktw { border-left: 4px solid var(--ktw-color); color: var(--ktw-color); }
        .resource-type-header.rtw { border-left: 4px solid var(--rtw-color); color: var(--rtw-color); }
        .resource-type-header.nef { border-left: 4px solid var(--nef-color); color: var(--nef-color); }
        .resource-type-header.naw { border-left: 4px solid var(--naw-color); color: var(--naw-color); }
        .resource-type-header.sonstiges { border-left: 4px solid var(--sonst-color); color: var(--sonst-color); }

        .resource-icon {
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .resource-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 12px;
            transition: all 0.2s;
            position: relative;
        }

        .resource-card.ktw { border-left: 3px solid var(--ktw-color); }
        .resource-card.rtw { border-left: 3px solid var(--rtw-color); }
        .resource-card.nef { border-left: 3px solid var(--nef-color); }
        .resource-card.naw { border-left: 3px solid var(--naw-color); }
        .resource-card.sonstiges { border-left: 3px solid var(--sonst-color); }

        .resource-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .resource-name {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.3;
        }

        .btn-delete-resource {
            background: transparent;
            color: var(--accent-red);
            border: none;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 16px;
            line-height: 1;
            transition: all 0.2s;
        }

        .btn-delete-resource:hover {
            background: var(--accent-red);
            color: white;
            border-radius: 2px;
        }

        .resource-status {
            margin-bottom: 8px;
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .current-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 2px;
            font-weight: 600;
            margin-top: 4px;
            font-size: 10px;
        }

        .status-1 { background: var(--accent-green); color: white; }
        .status-3 { background: var(--accent-blue); color: white; }
        .status-4 { background: var(--accent-yellow); color: black; }
        .status-7 { background: var(--accent-orange); color: white; }
        .status-8 { background: var(--accent-red); color: white; }

        .status-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }

        .btn-status {
            padding: 6px 2px;
            background: var(--btn-secondary);
            color: var(--text-primary);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-status:hover {
            transform: translateY(-1px);
        }

        .btn-status.status-1:hover { background: var(--accent-green); color: white; }
        .btn-status.status-3:hover { background: var(--accent-blue); color: white; }
        .btn-status.status-4:hover { background: var(--accent-yellow); color: black; }
        .btn-status.status-7:hover { background: var(--accent-orange); color: white; }
        .btn-status.status-8:hover { background: var(--accent-red); color: white; }

        /* Patienten-Liste */
        .patient-filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .patient-filter-tab {
            padding: 10px 20px;
            background: var(--btn-secondary);
            color: var(--text-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .patient-filter-tab:hover {
            background: var(--btn-secondary-hover);
        }

        .patient-filter-tab.active {
            background: var(--accent-blue);
            color: white;
        }

        .patients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .patient-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .patient-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .patient-card.sk1 { border-left: 4px solid var(--sichtung-rot); }
        .patient-card.sk2 { border-left: 4px solid var(--sichtung-gelb); }
        .patient-card.sk3 { border-left: 4px solid var(--sichtung-gruen); }
        .patient-card.entlassen { border-left: 4px solid var(--status-entlassen); opacity: 0.7; }
        .patient-card.ambulant { border-left: 4px solid var(--accent-purple); }

        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }

        .patient-number {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-red);
        }

        .patient-sichtung {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .patient-sichtung.sk1 { background: var(--sichtung-rot); color: white; }
        .patient-sichtung.sk2 { background: var(--sichtung-gelb); color: black; }
        .patient-sichtung.sk3 { background: var(--sichtung-gruen); color: white; }

        .patient-compact-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        
        .patient-compact-label {
            color: var(--text-tertiary);
            font-size: 10px;
            text-transform: uppercase;
        }

        .patient-compact-value {
            font-weight: 500;
        }

        .btn-edit-patient {
            width: 100%;
            padding: 6px;
            background: var(--btn-secondary);
            color: var(--text-primary);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 11px;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .btn-edit-patient:hover {
            background: var(--btn-secondary-hover);
        }

        /* Transport Button - GR√ñSSER & FARBIG */
        .btn-transport {
            width: 100%;
            padding: 12px 10px;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
            transition: all 0.2s;
        }

        .btn-transport:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .btn-transport .icon {
            font-size: 18px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: 4px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
        }

        .modal-warning {
            background: var(--accent-red);
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-warning .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .modal-export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 25px 0;
        }

        .btn-modal-export {
            padding: 15px 30px;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-modal-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-modal-export .icon {
            font-size: 28px;
        }

        .log-section {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 2px;
            margin-top: 30px;
        }

        .log-section.readonly {
            opacity: 0.9;
        }

        .log-section.readonly .log-header-top::after {
            content: '(Nur Lesen)';
            color: var(--text-tertiary);
            font-size: 12px;
            margin-left: 10px;
        }

        .log-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .log-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .log-title {
            font-size: 18px;
            font-weight: 300;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 10px;
            margin-bottom: 6px;
        }

        .filter-group select {
            padding: 8px 10px;
            font-size: 13px;
        }

        .btn-reset-filter {
            padding: 8px 16px;
            background: var(--btn-secondary);
            color: var(--text-primary);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            align-self: flex-end;
        }

        .log-entry {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--entry-border);
            padding: 15px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        .log-entry.priority-eilig { border-left-color: var(--accent-orange); border-left-width: 4px; }
        .log-entry.patient-entry { border-left-width: 4px; }
        .log-entry.patient-entry.sk1 { border-left-color: var(--sichtung-rot); }
        .log-entry.patient-entry.sk2 { border-left-color: var(--sichtung-gelb); }
        .log-entry.patient-entry.sk3 { border-left-color: var(--sichtung-gruen); }
        .log-entry.entlassen-entry { border-left-color: var(--status-entlassen); border-left-width: 4px; }

        .log-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .log-number { color: var(--accent-red); font-weight: bold; }
        .log-time { color: var(--text-secondary); font-weight: 500; }
        .log-function { color: var(--accent-blue); font-weight: 600; }

        .priority-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-eilig { background: var(--accent-orange); color: white; }
        .priority-einfach { background: var(--btn-secondary); color: var(--text-primary); }

        .sichtung-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .sichtung-badge.sk1 { background: var(--sichtung-rot); color: white; }
        .sichtung-badge.sk2 { background: var(--sichtung-gelb); color: black; }
        .sichtung-badge.sk3 { background: var(--sichtung-gruen); color: white; }

        .log-content {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 15px;
            margin-bottom: 8px;
        }

        .log-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-tertiary);
        }

        .log-value { font-size: 14px; }
        .log-message { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); }
        .empty-state { text-align: center; padding: 40px; color: var(--text-tertiary); font-style: italic; }
        .hidden { display: none !important; }
        
        .patient-actions-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn-new-patient {
            background: var(--accent-green);
            color: white;
            flex: 2;
            font-weight: 600;
        }
        
        .btn-new-patient:hover { background: #218838; }

        .btn-ambulant {
            background: var(--accent-purple);
            color: white;
            flex: 1;
            font-weight: 600;
        }

        .btn-ambulant:hover { background: #5a32a3; }

        .patient-export-row {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        /* Textarea gleiche Gr√∂√üe */
        .equal-textarea {
            min-height: 60px !important;
            max-height: 60px !important;
            resize: none !important;
        }

        @media (max-width: 1024px) {
            .standard-messages-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .resources-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
            .patients-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            .verletztenstatus-grid { grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); }
            .form-row-5 { grid-template-columns: repeat(2, 1fr); }
            .kategorie-buttons { flex-wrap: wrap; }
            .btn-kategorie { min-width: 60px; }
            .abcde-grid { grid-template-columns: repeat(3, 1fr); }
            .vitalwerte-grid { grid-template-columns: repeat(2, 1fr); }
            .adresse-grid { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .header-content { flex-direction: column; align-items: flex-start; width: 100%; }
            .logo-container { margin-bottom: 10px; }
            .tabs { overflow-x: auto; width: 100%; }
            .form-row, .form-row-3, .form-row-4, .form-row-5 { grid-template-columns: 1fr; }
            .standard-messages-grid { grid-template-columns: 1fr; }
            .filter-row { grid-template-columns: 1fr; }
            .log-content { grid-template-columns: 1fr; gap: 5px; }
            .resource-add-form { flex-direction: column; }
            .resources-grid { grid-template-columns: 1fr; }
            .patients-grid { grid-template-columns: 1fr; }
            .status-buttons { grid-template-columns: repeat(3, 1fr); }
            .gender-buttons { flex-direction: column; }
            .verletztenstatus-grid { grid-template-columns: repeat(3, 1fr); }
            .kategorie-buttons { flex-direction: column; }
            .btn-kategorie { width: 100%; }
            .patient-actions-row { flex-direction: column; }
            .login-functions { grid-template-columns: 1fr; }
            .sichtung-compact { flex-direction: column; }
            .abcde-grid { grid-template-columns: 1fr; }
            .vitalwerte-grid { grid-template-columns: 1fr; }
            .adresse-grid { grid-template-columns: 1fr; }
            .modal-export-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo logo-sc">
                    <svg viewBox="0 0 100 100" width="100%" height="100%">
                        <circle cx="50" cy="50" r="48" fill="white" stroke="black" stroke-width="2"/>
                        <text x="50" y="55" text-anchor="middle" font-size="25" font-family="Arial" font-weight="bold">SC</text>
                    </svg>
                </div>
                <div class="logo logo-drk">
                    <svg viewBox="0 0 100 100" width="100%" height="100%">
                        <circle cx="50" cy="50" r="48" fill="white" stroke="#dc3545" stroke-width="2"/>
                        <rect x="40" y="20" width="20" height="60" fill="#dc3545"/>
                        <rect x="20" y="40" width="60" height="20" fill="#dc3545"/>
                    </svg>
                </div>
            </div>
            <h2 class="login-title">Einsatzdokumentation</h2>
            <p class="login-subtitle">Sanit√§tsdienst SC Freiburg - Bitte Funktion w√§hlen</p>
            <div class="login-functions">
                <button class="btn-login-function einsatzleitung" onclick="login('Einsatzleitung')">
                    <span class="icon">üë®‚Äç‚úàÔ∏è</span>
                    <span>Einsatzleitung</span>
                </button>
                <button class="btn-login-function fuehrungsassistent" onclick="login('F√ºhrungsassistent')">
                    <span class="icon">üìã</span>
                    <span>F√ºhrungsassistent</span>
                </button>
                <button class="btn-login-function mc1" onclick="login('MC 1')">
                    <span class="icon">üè•</span>
                    <span>MC 1</span>
                </button>
                <button class="btn-login-function mc2" onclick="login('MC 2')">
                    <span class="icon">üè•</span>
                    <span>MC 2</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo logo-sc">
                        <svg viewBox="0 0 100 100" width="100%" height="100%">
                            <circle cx="50" cy="50" r="48" fill="white" stroke="black" stroke-width="2"/>
                            <text x="50" y="55" text-anchor="middle" font-size="25" font-family="Arial" font-weight="bold">SC</text>
                        </svg>
                    </div>
                    <h1>Einsatzdokumentation Sanit√§tsdienst SC Freiburg</h1>
                </div>
            </div>
            <div class="header-actions">
                <div class="user-info">
                    <span>Angemeldet als:</span>
                    <span class="user-function" id="currentUserFunction">-</span>
                    <button class="btn-logout" onclick="logout()">Abmelden</button>
                    <button class="btn-end-mission hidden" id="btnEndMission" onclick="openEndMissionModal()">üõë Einsatz beenden</button>
                </div>
                <div class="logo logo-drk">
                     <svg viewBox="0 0 100 100" width="100%" height="100%">
                        <circle cx="50" cy="50" r="48" fill="white" stroke="#dc3545" stroke-width="2"/>
                        <rect x="40" y="20" width="20" height="60" fill="#dc3545"/>
                        <rect x="20" y="40" width="60" height="20" fill="#dc3545"/>
                    </svg>
                </div>
            </div>
        </header>

        <div class="tabs" id="mainTabs">
            <button class="tab-button active" onclick="switchTab('meldungen')" id="tabMeldungen">Meldungen</button>
            <button class="tab-button" onclick="switchTab('ressourcen')" id="tabRessourcen">Ressourcen</button>
            <button class="tab-button" onclick="switchTab('patienten')" id="tabPatienten">Patienten</button>
        </div>

        <!-- Tab: Meldungen -->
        <div id="tab-meldungen" class="tab-content active">
            <div class="form-section" id="meldungFormSection">
                <form id="einsatzForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Art der Meldung</label>
                            <select id="artMeldung" required>
                                <option value="Funkspruch" selected>Funkspruch</option>
                                <option value="Entscheidung">Entscheidung</option>
                                <option value="Befund">Befund</option>
                                <option value="Ma√ünahme">Ma√ünahme</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Vorrangstufe</label>
                            <select id="vorrangstufe" required>
                                <option value="Einfach" selected>Einfach</option>
                                <option value="Eilig">Eilig</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Funktion</label>
                            <input type="text" id="funktion" readonly>
                        </div>
                        <div class="form-group">
                            <label class="required">Absender</label>
                            <input type="text" id="absender" value="F√ºASs" required>
                        </div>
                    </div>

                    <div class="standard-messages-grid">
                        <div class="form-group">
                            <label>POSTEN EINSATZBEREIT</label>
                            <select onchange="insertMessage(this)">
                                <option value="">-- Ausw√§hlen --</option>
                                <option value="Einsatzleitung funk- und einsatzbereit">Einsatzleitung funk- und einsatzbereit</option>
                                <option value="Ost 1 auf Posten und einsatzklar.">Ost 1 auf Posten und einsatzklar.</option>
                                <option value="Ost 13 auf Posten und einsatzklar.">Ost 13 auf Posten und einsatzklar.</option>
                                <option value="Ost 6 auf Posten und einsatzklar.">Ost 6 auf Posten und einsatzklar.</option>
                                <option value="Nord 1 auf Posten und einsatzklar.">Nord 1 auf Posten und einsatzklar.</option>
                                <option value="Nord 4 auf Posten und einsatzklar.">Nord 4 auf Posten und einsatzklar.</option>
                                <option value="West 1 auf Posten und einsatzklar.">West 1 auf Posten und einsatzklar.</option>
                                <option value="West 7 auf Posten und einsatzklar.">West 7 auf Posten und einsatzklar.</option>
                                <option value="S√ºd 1 auf Posten und einsatzklar.">S√ºd 1 auf Posten und einsatzklar.</option>
                                <option value="S√ºd 2 auf Posten und einsatzklar.">S√ºd 2 auf Posten und einsatzklar.</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>BANK & MC</label>
                            <select onchange="insertMessage(this)">
                                <option value="">-- Ausw√§hlen --</option>
                                <option value="Bank eingerichtet und einsatzklar.">Bank eingerichtet und einsatzklar.</option>
                                <option value="Bank einsatzklar auf Posten.">Bank einsatzklar auf Posten.</option>
                                <option value="Bank r√ºckt ins MC 1 ein.">Bank r√ºckt ins MC 1 ein.</option>
                                <option value="MC 1 einsatzklar.">MC 1 einsatzklar.</option>
                                <option value="MC 2 einsatzklar.">MC 2 einsatzklar.</option>
                                <option value="MC XX fordert NA an, NA XX entsendet.">MC XX fordert NA an, NA XX entsendet.</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ILS MELDUNGEN</label>
                            <select onchange="insertMessage(this)">
                                <option value="">-- Ausw√§hlen --</option>
                                <option value="Bei ILS einsatzklar gemeldet.">Bei ILS einsatzklar gemeldet.</option>
                                <option value="Bei ILS abgemeldet und Einsatzende.">Bei ILS abgemeldet und Einsatzende.</option>
                                <option value="MC XX fordert KTW zum Transport an. Bei ILS angefordert.">MC XX fordert KTW zum Transport an.</option>
                                <option value="MC XX fordert RTW zum Transport an. Bei ILS angefordert.">MC XX fordert RTW zum Transport an.</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>KTW STATUS</label>
                            <select onchange="insertMessage(this)">
                                <option value="">-- Ausw√§hlen --</option>
                                <option value="KTW hat Standort P6/ P7 erreicht.">KTW hat Standort P6/ P7 erreicht.</option>
                                <option value="KTW Standort zu P6/ P7 verlegen">KTW Standort zu P6/ P7 verlegen</option>
                                <option value="KTW Standort zu MC 2 verlegen.">KTW Standort zu MC 2 verlegen.</option>
                                <option value="KTW hat Standort MC 2 erreicht.">KTW hat Standort MC 2 erreicht.</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>POSTEN STATUS</label>
                            <select onchange="insertMessage(this)">
                                <option value="">-- Ausw√§hlen --</option>
                                <option value="Posten XX geht in Pause">Posten XX geht in Pause</option>
                                <option value="Posten XX geht mit Patient ins MC X">Posten XX geht mit Patient ins MC X</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>TRANSPORT</label>
                            <select onchange="insertMessage(this)">
                                <option value="">-- Ausw√§hlen --</option>
                                <option value="Transportbeginn in Zielklinik.">Transportbeginn</option>
                                <option value="Transport ins Medical Center.">Transport ins MC</option>
                                <option value="Transport durch Rettungsdienst.">Transport durch RD</option>
                                <option value="Patient verweigert Transport.">Transportverweigerung</option>
                                <option value="Transport abgeschlossen.">Transport Ende</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>STANDORT VERLEGUNGEN</label>
                            <select onchange="insertMessage(this)">
                                <option value="">-- Ausw√§hlen --</option>
                                <option value="Ost 13 Standort in Umlauf unter der Trib√ºne verlegen.">Ost 13 Standort in Umlauf verlegen.</option>
                                <option value="S√ºd 1 Standort vor Stadion bei ehemaliger Z√§pfleh√ºtte verlegen.">S√ºd 1 Standort Z√§pfleh√ºtte verlegen.</option>
                                <option value="S√ºd 2 Standort vor Stadion bei ehemaliger Z√§pfleh√ºtte verlegen.">S√ºd 2 Standort Z√§pfleh√ºtte verlegen.</option>
                                <option value="West 1 Standort vor Stadion am Eingang E2 verlegen.">West 1 Standort E2 verlegen.</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="required">Meldung</label>
                            <textarea id="meldung" placeholder="Meldungstext eingeben oder Standardmeldung ausw√§hlen..." required></textarea>
                        </div>
                    </div>

                    <div class="button-row">
                        <button type="submit" class="btn-send">Meldung senden</button>
                        <button type="button" class="btn-clear" onclick="clearForm()">Abbrechen</button>
                    </div>
                </form>
            </div>

            <!-- Protokoll -->
            <div class="log-section" id="logSection">
                <div class="log-header">
                    <div class="log-header-top">
                        <h2 class="log-title">Protokoll</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn-export csv" onclick="exportMeldungenCSV()">üì• Meldungen CSV</button>
                            <span class="log-count">Eintr√§ge: <span id="entryCount">0</span> / <span id="totalCount">0</span></span>
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Art der Meldung</label>
                            <select id="filterArt" onchange="applyFilters()">
                                <option value="">Alle</option>
                                <option value="Funkspruch">Funkspruch</option>
                                <option value="Entscheidung">Entscheidung</option>
                                <option value="Befund">Befund</option>
                                <option value="Ma√ünahme">Ma√ünahme</option>
                                <option value="Sonstiges">Sonstiges</option>
                                <option value="Patientenaufnahme">Patientenaufnahme</option>
                                <option value="Transport">Transport</option>
                                <option value="Entlassung">Entlassung</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Vorrangstufe</label>
                            <select id="filterVorrang" onchange="applyFilters()">
                                <option value="">Alle</option>
                                <option value="Einfach">Einfach</option>
                                <option value="Eilig">Eilig</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Absender</label>
                            <select id="filterAbsender" onchange="applyFilters()">
                                <option value="">Alle</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Fahrzeug</label>
                            <select id="filterFahrzeug" onchange="applyFilters()">
                                <option value="">Alle</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn-reset-filter" onclick="resetFilters()">Filter zur√ºcksetzen</button>
                        </div>
                    </div>
                </div>
                
                <div id="logEntries">
                    <div class="empty-state">Noch keine Eintr√§ge vorhanden</div>
                </div>
            </div>
        </div>

        <!-- Tab: Ressourcen -->
        <div id="tab-ressourcen" class="tab-content">
            <div class="form-section">
                <div class="resource-add-section">
                    <h3 style="margin-bottom: 15px; font-size: 16px; font-weight: 400;">Neue Ressource hinzuf√ºgen</h3>
                    <div class="resource-add-form">
                        <div class="form-group">
                            <label>Fahrzeugtyp</label>
                            <select id="newResourceType">
                                <option value="KTW">KTW</option>
                                <option value="RTW">RTW</option>
                                <option value="NEF">NEF</option>
                                <option value="NAW">NAW</option>
                                <option value="Sonstiges">Sonstiges</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Kennzeichen / Name</label>
                            <input type="text" id="newResourceName" placeholder="z.B. KTW 1, RTW 12/83-1">
                        </div>
                        <button class="btn-add-resource" onclick="addResource()">+ Hinzuf√ºgen</button>
                    </div>
                </div>

                <div id="resourcesContainer">
                    <div class="empty-state">Noch keine Ressourcen angelegt</div>
                </div>
            </div>
        </div>

        <!-- Tab: Patienten -->
        <div id="tab-patienten" class="tab-content">
            <div class="patient-actions-row" id="patientActionsRow">
                <button class="btn-new-patient" onclick="togglePatientForm(true, 'standard')">+ Neuen Patienten anlegen</button>
                <button class="btn-ambulant" onclick="togglePatientForm(true, 'ambulant')">ü©π Ambulant versorgt</button>
            </div>

            <!-- Container f√ºr das Formular -->
            <div id="patientFormContainer" class="hidden">
                <div class="form-section">
                    <h3 style="margin-bottom: 20px; font-size: 18px; font-weight: 400;">
                        <span id="formTitle">Neuen Patienten aufnehmen</span>
                    </h3>
                    
                    <form id="patientForm">
                        <input type="hidden" id="editPatientId">
                        <input type="hidden" id="isAmbulantMode" value="false">
                        
                        <!-- Sichtung & Kategorie -->
                        <div class="form-row">
                            <div class="form-group" id="sichtungGroup">
                                <label class="required">Sichtungskategorie</label>
                                <div class="sichtung-compact">
                                    <button type="button" class="btn-sichtung-compact sk1" onclick="selectSichtung('SK1')">
                                        <span class="icon">üî¥</span>
                                        <span>SK1 Rot</span>
                                    </button>
                                    <button type="button" class="btn-sichtung-compact sk2" onclick="selectSichtung('SK2')">
                                        <span class="icon">üü°</span>
                                        <span>SK2 Gelb</span>
                                    </button>
                                    <button type="button" class="btn-sichtung-compact sk3" onclick="selectSichtung('SK3')">
                                        <span class="icon">üü¢</span>
                                        <span>SK3 Gr√ºn</span>
                                    </button>
                                </div>
                                <input type="hidden" id="patientSichtung" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Kategorie</label>
                                <div class="kategorie-buttons">
                                    <button type="button" class="btn-kategorie" onclick="selectKategorie('Chir.')">
                                        <span class="icon">ü©π</span>
                                        <span>Chir.</span>
                                    </button>
                                    <button type="button" class="btn-kategorie" onclick="selectKategorie('Int.')">
                                        <span class="icon">‚ù§Ô∏è</span>
                                        <span>Int.</span>
                                    </button>
                                    <button type="button" class="btn-kategorie" onclick="selectKategorie('Neuro')">
                                        <span class="icon">üß†</span>
                                        <span>Neuro</span>
                                    </button>
                                    <button type="button" class="btn-kategorie" onclick="selectKategorie('P√§d.')">
                                        <span class="icon">üë∂</span>
                                        <span>P√§d.</span>
                                    </button>
                                    <button type="button" class="btn-kategorie" onclick="selectKategorie('Sonst.')">
                                        <span class="icon">üìã</span>
                                        <span>Sonst.</span>
                                    </button>
                                </div>
                                <input type="hidden" id="patientKategorie" required>
                            </div>
                        </div>

                        <!-- Pers√∂nliche Daten -->
                        <div class="form-row-4" id="personalDataRow">
                            <div class="form-group">
                                <label class="required">Nachname</label>
                                <input type="text" id="patientNachname" placeholder="Nachname" required tabindex="1">
                            </div>
                            <div class="form-group">
                                <label>Vorname</label>
                                <input type="text" id="patientVorname" placeholder="Vorname" tabindex="2">
                            </div>
                            <div class="form-group ambulant-hide">
                                <label>Alter</label>
                                <input type="number" id="patientAlter" placeholder="Alter" min="0" max="150" tabindex="3">
                            </div>
                            <div class="form-group">
                                <label>Geschlecht</label>
                                <div class="gender-buttons">
                                    <button type="button" class="btn-gender" onclick="selectGender('m√§nnlich')">üë®</button>
                                    <button type="button" class="btn-gender" onclick="selectGender('weiblich')">üë©</button>
                                    <button type="button" class="btn-gender" onclick="selectGender('divers')">‚öß</button>
                                </div>
                                <input type="hidden" id="patientGeschlecht">
                            </div>
                        </div>

                        <!-- Ort & Kontakt -->
                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="required">Gesichtet durch</label>
                                <select id="patientGesichtetDurch" required>
                                    <option value="">-- W√§hlen --</option>
                                    <option value="MC 1">MC 1</option>
                                    <option value="MC 2">MC 2</option>
                                    <option value="Ost 1">Ost 1</option>
                                    <option value="Ost 13">Ost 13</option>
                                    <option value="Ost 6">Ost 6</option>
                                    <option value="Nord 1">Nord 1</option>
                                    <option value="Nord 4">Nord 4</option>
                                    <option value="West 1">West 1</option>
                                    <option value="West 7">West 7</option>
                                    <option value="S√ºd 1">S√ºd 1</option>
                                    <option value="S√ºd 2">S√ºd 2</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="required">Sichtungsort</label>
                                <input type="text" id="patientSichtungsort" placeholder="z.B. Block A4" required>
                            </div>
                            <div class="form-group">
                                <label class="required">Abschnitt</label>
                                <select id="patientAbschnitt" required>
                                    <option value="">-- W√§hlen --</option>
                                    <option value="Ost">Ost</option>
                                    <option value="S√ºd">S√ºd</option>
                                    <option value="Nord">Nord</option>
                                    <option value="West">West</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="required">Patientenort / MC</label>
                                <select id="patientOrt" required>
                                    <option value="">-- W√§hlen --</option>
                                    <option value="MC 1">MC 1</option>
                                    <option value="MC 2">MC 2</option>
                                </select>
                            </div>
                            <div class="form-group ambulant-hide">
                                <label>Geburtsdatum</label>
                                <input type="date" id="patientGeburtsdatum">
                            </div>
                            <div class="form-group ambulant-hide">
                                <label>Telefon</label>
                                <input type="tel" id="patientTelefon" placeholder="Telefonnummer" tabindex="10">
                            </div>
                        </div>

                        <!-- Adresse -->
                        <div class="compact-section ambulant-hide">
                            <div class="compact-section-header">
                                <span class="header-icon">üè†</span>
                                <span>Adresse</span>
                            </div>
                            <div class="compact-section-body">
                                <div class="adresse-grid">
                                    <div class="form-group">
                                        <label>Stra√üe</label>
                                        <input type="text" id="patientStrasse" placeholder="Stra√üe" tabindex="11">
                                    </div>
                                    <div class="form-group">
                                        <label>Hausnr.</label>
                                        <input type="text" id="patientHausnummer" placeholder="Nr." tabindex="12">
                                    </div>
                                    <div class="form-group">
                                        <label>PLZ</label>
                                        <input type="text" id="patientPLZ" placeholder="PLZ" tabindex="13">
                                    </div>
                                    <div class="form-group">
                                        <label>Ort</label>
                                        <input type="text" id="patientWohnort" placeholder="Ort" tabindex="14">
                                    </div>
                                    <div class="form-group">
                                        <label>Kontaktperson</label>
                                        <input type="text" id="patientKontaktperson" placeholder="Angeh√∂rige" tabindex="15">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ABCDE Beurteilung - NEU GESTALTET -->
                        <div class="compact-section medical-deep-data">
                            <div class="compact-section-header">
                                <span class="header-icon">ü©∫</span>
                                <span>ABCDE Beurteilung</span>
                            </div>
                            <div class="compact-section-body">
                                <div class="abcde-grid">
                                    <div class="abcde-item">
                                        <div class="abcde-letter a">A</div>
                                        <div class="abcde-label">Airway</div>
                                        <select id="patientAirway">
                                            <option value="">--</option>
                                            <option value="Frei">Frei</option>
                                            <option value="Gef√§hrdet">Gef√§hrdet</option>
                                            <option value="Verlegt">Verlegt</option>
                                            <option value="Gesichert (Tubus)">Gesichert (Tubus)</option>
                                            <option value="Gesichert (SGA)">Gesichert (SGA)</option>
                                        </select>
                                    </div>
                                    <div class="abcde-item">
                                        <div class="abcde-letter b">B</div>
                                        <div class="abcde-label">Breathing</div>
                                        <select id="patientBreathing">
                                            <option value="">--</option>
                                            <option value="Unauff√§llig">Unauff√§llig</option>
                                            <option value="Tachypnoe">Tachypnoe</option>
                                            <option value="Bradypnoe">Bradypnoe</option>
                                            <option value="Dyspnoe">Dyspnoe</option>
                                            <option value="Apnoe">Apnoe</option>
                                            <option value="Beatmet">Beatmet</option>
                                        </select>
                                    </div>
                                    <div class="abcde-item">
                                        <div class="abcde-letter c">C</div>
                                        <div class="abcde-label">Circulation</div>
                                        <select id="patientCirculation">
                                            <option value="">--</option>
                                            <option value="Stabil">Stabil</option>
                                            <option value="Tachykard">Tachykard</option>
                                            <option value="Bradykard">Bradykard</option>
                                            <option value="Hypotonie">Hypotonie</option>
                                            <option value="Hypertonie">Hypertonie</option>
                                            <option value="Schock">Schock</option>
                                            <option value="Rekapzeit >2s">Rekapzeit >2s</option>
                                            <option value="Kreislaufstillstand">Kreislaufstillstand</option>
                                        </select>
                                    </div>
                                    <div class="abcde-item">
                                        <div class="abcde-letter d">D</div>
                                        <div class="abcde-label">Disability</div>
                                        <select id="patientDisability">
                                            <option value="">--</option>
                                            <option value="Wach (Alert)">Wach (Alert)</option>
                                            <option value="Reagiert auf Ansprache (Voice)">Reagiert auf Ansprache</option>
                                            <option value="Reagiert auf Schmerz (Pain)">Reagiert auf Schmerz</option>
                                            <option value="Keine Reaktion (Unresponsive)">Keine Reaktion</option>
                                            <option value="Orientiert">Orientiert</option>
                                            <option value="Desorientiert">Desorientiert</option>
                                            <option value="Krampfanfall">Krampfanfall</option>
                                        </select>
                                    </div>
                                    <div class="abcde-item">
                                        <div class="abcde-letter e">E</div>
                                        <div class="abcde-label">Exposure</div>
                                        <select id="patientExposure">
                                            <option value="">--</option>
                                            <option value="Unauff√§llig">Unauff√§llig</option>
                                            <option value="Hypotherm">Hypotherm</option>
                                            <option value="Hypertherm/Fieber">Hypertherm/Fieber</option>
                                            <option value="Hautver√§nderungen">Hautver√§nderungen</option>
                                            <option value="Verletzungen sichtbar">Verletzungen sichtbar</option>
                                            <option value="Blutung">Blutung</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vitalwerte - NEU GESTALTET -->
                        <div class="compact-section medical-deep-data">
                            <div class="compact-section-header">
                                <span class="header-icon">üíì</span>
                                <span>Vitalwerte</span>
                            </div>
                            <div class="compact-section-body">
                                <div class="vitalwerte-grid">
                                    <div class="vitalwert-card">
                                        <div class="vitalwert-header">BZ (mg/dl)</div>
                                        <div class="vitalwert-body">
                                            <div class="vitalwerte-input">
                                                <input type="number" id="inputBZ" placeholder="95" min="0" max="999">
                                                <button type="button" class="btn-add-vital" onclick="addVitalwert('bz')">+</button>
                                            </div>
                                            <div id="bzHistory" class="vital-history"></div>
                                        </div>
                                    </div>
                                    <div class="vitalwert-card">
                                        <div class="vitalwert-header">RR (sys/dia)</div>
                                        <div class="vitalwert-body">
                                            <div class="vitalwerte-input">
                                                <input type="number" id="inputRRSys" placeholder="120" min="0" max="300" style="flex: 1;">
                                                <span>/</span>
                                                <input type="number" id="inputRRDia" placeholder="80" min="0" max="200" style="flex: 1;">
                                                <button type="button" class="btn-add-vital" onclick="addVitalwert('rr')">+</button>
                                            </div>
                                            <div id="rrHistory" class="vital-history"></div>
                                        </div>
                                    </div>
                                    <div class="vitalwert-card">
                                        <div class="vitalwert-header">Puls (/min)</div>
                                        <div class="vitalwert-body">
                                            <div class="vitalwerte-input">
                                                <input type="number" id="inputPuls" placeholder="72" min="0" max="300">
                                                <button type="button" class="btn-add-vital" onclick="addVitalwert('puls')">+</button>
                                            </div>
                                            <div id="pulsHistory" class="vital-history"></div>
                                        </div>
                                    </div>
                                    <div class="vitalwert-card">
                                        <div class="vitalwert-header">SpO2 (%)</div>
                                        <div class="vitalwert-body">
                                            <div class="vitalwerte-input">
                                                <input type="number" id="inputSpO2" placeholder="98" min="0" max="100">
                                                <button type="button" class="btn-add-vital" onclick="addVitalwert('spo2')">+</button>
                                            </div>
                                            <div id="spo2History" class="vital-history"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status / Ma√ünahmen - NEU GESTALTET -->
                        <div class="compact-section medical-deep-data">
                            <div class="compact-section-header">
                                <span class="header-icon">‚ö°</span>
                                <span>Status / Ma√ünahmen</span>
                            </div>
                            <div class="compact-section-body">
                                <div class="verletztenstatus-grid">
                                    <button type="button" class="btn-verletztenstatus sauerstoff" onclick="toggleVerletztenstatus('sauerstoff')">
                                        <span class="icon">üí®</span>
                                        <span>O2</span>
                                    </button>
                                    <button type="button" class="btn-verletztenstatus monitor" onclick="toggleVerletztenstatus('monitor')">
                                        <span class="icon">üìä</span>
                                        <span>Monitor</span>
                                    </button>
                                    <button type="button" class="btn-verletztenstatus intubiert" onclick="toggleVerletztenstatus('intubiert')">
                                        <span class="icon">ü´Å</span>
                                        <span>Tubus</span>
                                    </button>
                                    <button type="button" class="btn-verletztenstatus beatmet" onclick="toggleVerletztenstatus('beatmet')">
                                        <span class="icon">üå¨Ô∏è</span>
                                        <span>Beatmet</span>
                                    </button>
                                    <button type="button" class="btn-verletztenstatus reanimiert" onclick="toggleVerletztenstatus('reanimiert')">
                                        <span class="icon">üíì</span>
                                        <span>REA</span>
                                    </button>
                                </div>
                                <input type="hidden" id="patientVerletztenstatus" value="">
                            </div>
                        </div>

                        <!-- GCS, Schmerz, Pupillen -->
                        <div class="compact-section medical-deep-data">
                            <div class="compact-section-header">
                                <span class="header-icon">üß†</span>
                                <span>Neurologische Beurteilung</span>
                            </div>
                            <div class="compact-section-body">
                                <div class="form-row-3">
                                    <div class="form-group">
                                        <label>GCS (3-15)</label>
                                        <input type="number" id="patientGCS" placeholder="15" min="3" max="15">
                                    </div>
                                    <div class="form-group">
                                        <label>Schmerz (0-10)</label>
                                        <input type="number" id="patientSchmerzskala" placeholder="0" min="0" max="10">
                                    </div>
                                    <div class="form-group">
                                        <label>Pupillen</label>
                                        <select id="patientPupillen">
                                            <option value="">--</option>
                                            <option value="Isokor, lichtreagibel">Isokor, lichtreagibel</option>
                                            <option value="Anisokor">Anisokor</option>
                                            <option value="Weit, nicht reagibel">Weit, nicht reagibel</option>
                                            <option value="Eng, reagibel">Eng, reagibel</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Verletzung & Allergien -->
                        <div class="form-row ambulant-hide-extra">
                            <div class="form-group">
                                <label>Verletzung</label>
                                <textarea id="patientVerletzungsbereich" placeholder="Verletzungsbereich..." class="equal-textarea"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Allergien</label>
                                <textarea id="patientAllergien" placeholder="Allergien..." class="equal-textarea"></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="required">Diagnose / Notizen</label>
                            <textarea id="patientDiagnose" placeholder="Diagnose..." required style="min-height: 100px;"></textarea>
                        </div>

                        <!-- Transportziel & Ressource - NUR f√ºr Einsatzleitung/F√ºAss -->
                        <div class="form-row medical-deep-data transport-section">
                            <div class="form-group">
                                <label>Zielort</label>
                                <input type="text" id="patientTransportziel" placeholder="z.B. Klinikum">
                            </div>
                            <div class="form-group">
                                <label>Ressource zuweisen (Nur Status 1)</label>
                                <select id="patientTransportResource">
                                    <option value="">-- Keine --</option>
                                </select>
                            </div>
                        </div>

                        <div class="button-row">
                            <button type="submit" class="btn-send" id="submitPatientBtn">Speichern</button>
                            <button type="button" class="btn-clear" onclick="togglePatientForm(false)">Abbrechen</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="form-section" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-size: 18px; font-weight: 400;">
                        Patienten-√úbersicht 
                        <span style="color: var(--text-secondary); font-size: 14px; font-weight: 300;">
                            (Total: <span id="patientCount">0</span>)
                        </span>
                    </h3>
                    <button class="btn-export csv" onclick="exportPatientenCSV()">üì• Patienten CSV</button>
                </div>

                <div class="patient-filter-tabs">
                    <button class="patient-filter-tab active" onclick="filterPatients('alle')">Alle</button>
                    <button class="patient-filter-tab" onclick="filterPatients('aktuell')">Aktuell</button>
                    <button class="patient-filter-tab" onclick="filterPatients('mc1')">MC 1</button>
                    <button class="patient-filter-tab" onclick="filterPatients('mc2')">MC 2</button>
                    <button class="patient-filter-tab" onclick="filterPatients('ambulant')">Ambulant</button>
                    <button class="patient-filter-tab" onclick="filterPatients('entlassen')">Entlassen</button>
                </div>

                <div id="patientsContainer" class="patients-grid">
                    <div class="empty-state">Noch keine Patienten aufgenommen</div>
                </div>
            </div>

            <!-- Meldungsfenster f√ºr MC Ansicht (nur lesen) -->
            <div id="mcLogSection" class="log-section readonly hidden">
                <div class="log-header">
                    <div class="log-header-top">
                        <h2 class="log-title">Meldungen</h2>
                    </div>
                </div>
                <div id="mcLogEntries">
                    <div class="empty-state">Noch keine Eintr√§ge vorhanden</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transport Modal -->
    <div id="transportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Patient transportieren</h3>
                <button class="modal-close" onclick="closeTransportModal()">&times;</button>
            </div>
            <form id="transportForm">
                <input type="hidden" id="transportPatientId">
                <div class="form-group">
                    <label class="required">Transportfahrzeug (Nur Status 1)</label>
                    <select id="transportFahrzeug" required>
                        <option value="">-- Ausw√§hlen --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="required">Zielklinik</label>
                    <input type="text" id="transportZielklinik" placeholder="z.B. Klinikum Stuttgart" required>
                </div>
                <div class="button-row">
                    <button type="submit" class="btn-send">Transport starten</button>
                    <button type="button" class="btn-clear" onclick="closeTransportModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Einsatz beenden Modal -->
    <div id="endMissionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Einsatz beenden</h3>
                <button class="modal-close" onclick="closeEndMissionModal()">&times;</button>
            </div>
            <div class="modal-warning">
                <div class="icon">‚ö†Ô∏è</div>
                <strong>Achtung!</strong><br>
                Der Einsatz wird f√ºr alle Benutzer beendet.
            </div>
            <p style="margin-bottom: 15px; text-align: center;">
                Bitte laden Sie die CSV-Dateien herunter, bevor Sie den Einsatz beenden:
            </p>
            
            <div class="modal-export-buttons">
                <button class="btn-modal-export" onclick="exportMeldungenCSV()">
                    <span class="icon">üìã</span>
                    <span>Meldungen CSV</span>
                </button>
                <button class="btn-modal-export" onclick="exportPatientenCSV()">
                    <span class="icon">üè•</span>
                    <span>Patienten CSV</span>
                </button>
            </div>

            <div class="button-row" style="justify-content: center; margin-top: 25px;">
                <button class="btn-send" onclick="endMission()">üõë Einsatz beenden & Daten l√∂schen</button>
                <button class="btn-clear" onclick="closeEndMissionModal()">Abbrechen</button>
            </div>
        </div>
    </div>

    <script>
        let entryCounter = 0;
        let patientCounter = 0;
        const entries = [];
        const absenderSet = new Set();
        const fahrzeugSet = new Set();
        let resources = [];
        let patients = [];
        let selectedSichtung = null;
        let selectedGender = null;
        let selectedVerletztenstatus = [];
        let selectedKategorie = null;
        let currentPatientFilter = 'alle';
        let editingPatientId = null;
        let isAmbulantEntry = false;
        let currentUserFunction = null;
        let isMCView = false;

        // Vitalwerte Storage
        let currentVitalwerte = {
            bz: [],
            rr: [],
            puls: [],
            spo2: []
        };

        const statusTexts = {
            '1': 'Einsatzbereit',
            '3': 'Auftrag angenommen',
            '4': 'Ankunft Patient',
            '7': 'Patient aufgenommen',
            '8': 'Ankunft Zielort'
        };

        const vehicleIcons = {
            'KTW': 'üöê',
            'RTW': 'üöë',
            'NEF': 'üöó',
            'NAW': 'üö®',
            'Sonstiges': 'üöô'
        };

        // Login-Funktion
        function login(funktion) {
            currentUserFunction = funktion;
            isMCView = (funktion === 'MC 1' || funktion === 'MC 2');
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUserFunction').textContent = funktion;
            document.getElementById('funktion').value = funktion;
            
            applyViewRestrictions();
        }

        function logout() {
            currentUserFunction = null;
            isMCView = false;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').style.display = 'none';
        }

        function applyViewRestrictions() {
            // Einsatz beenden Button nur f√ºr Einsatzleitung
            if (currentUserFunction === 'Einsatzleitung') {
                document.getElementById('btnEndMission').classList.remove('hidden');
            } else {
                document.getElementById('btnEndMission').classList.add('hidden');
            }

            // Transport-Sektion nur f√ºr Einsatzleitung/F√ºhrungsassistent
            if (isMCView) {
                document.querySelectorAll('.transport-section').forEach(el => el.classList.add('hidden'));
            } else {
                document.querySelectorAll('.transport-section').forEach(el => el.classList.remove('hidden'));
            }

            if (isMCView) {
                // MC1/MC2: Nur Patienten-Tab sichtbar
                document.getElementById('tabMeldungen').classList.add('hidden');
                document.getElementById('tabRessourcen').classList.add('hidden');
                
                // Direkt zum Patienten-Tab wechseln
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById('tabPatienten').classList.add('active');
                document.getElementById('tab-patienten').classList.add('active');
                
                // Meldungsfenster nur lesen anzeigen
                document.getElementById('mcLogSection').classList.remove('hidden');
                
                // MC kann Patienten anlegen
                document.getElementById('patientActionsRow').classList.remove('hidden');
            } else {
                // Einsatzleitung / F√ºhrungsassistent: Vollzugriff
                document.getElementById('tabMeldungen').classList.remove('hidden');
                document.getElementById('tabRessourcen').classList.remove('hidden');
                document.getElementById('mcLogSection').classList.add('hidden');
                document.getElementById('patientActionsRow').classList.remove('hidden');
            }
        }

        // Einsatz beenden Modal
        function openEndMissionModal() {
            document.getElementById('endMissionModal').classList.add('active');
        }

        function closeEndMissionModal() {
            document.getElementById('endMissionModal').classList.remove('active');
        }

        function endMission() {
            // Alle Daten l√∂schen
            entryCounter = 0;
            patientCounter = 0;
            entries.length = 0;
            patients.length = 0;
            resources.length = 0;
            absenderSet.clear();
            fahrzeugSet.clear();
            
            // UI aktualisieren
            renderEntries();
            renderPatients();
            renderResources();
            updateAbsenderFilter();
            updateFahrzeugFilter();
            
            closeEndMissionModal();
            alert('Einsatz wurde beendet. Alle Daten wurden gel√∂scht.');
            
            // Zur√ºck zum Login
            logout();
        }

        // Tab-Wechsel
        function switchTab(tabName) {
            if (isMCView && tabName !== 'patienten') return;
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Toggle Patient Form
        function togglePatientForm(show, mode = 'standard') {
            const container = document.getElementById('patientFormContainer');
            const btns = document.querySelector('.patient-actions-row');
            
            if (show) {
                container.classList.remove('hidden');
                btns.classList.add('hidden');
                
                isAmbulantEntry = (mode === 'ambulant');
                document.getElementById('isAmbulantMode').value = isAmbulantEntry;

                if (isAmbulantEntry) {
                    document.querySelectorAll('.medical-deep-data').forEach(el => el.classList.add('hidden'));
                    document.querySelectorAll('.ambulant-hide').forEach(el => el.classList.add('hidden'));
                    document.querySelectorAll('.ambulant-hide-extra').forEach(el => el.classList.add('hidden'));
                    document.getElementById('sichtungGroup').classList.add('hidden');
                    document.getElementById('formTitle').textContent = 'Ambulante Versorgung aufnehmen';
                } else {
                    document.querySelectorAll('.medical-deep-data').forEach(el => el.classList.remove('hidden'));
                    document.querySelectorAll('.ambulant-hide').forEach(el => el.classList.remove('hidden'));
                    document.querySelectorAll('.ambulant-hide-extra').forEach(el => el.classList.remove('hidden'));
                    document.getElementById('sichtungGroup').classList.remove('hidden');
                    document.getElementById('formTitle').textContent = 'Neuen Patienten aufnehmen';
                    
                    // Transport-Sektion f√ºr MC ausblenden
                    if (isMCView) {
                        document.querySelectorAll('.transport-section').forEach(el => el.classList.add('hidden'));
                    }
                }

                if (!editingPatientId) {
                    clearPatientForm(false);
                }
                
                updateResourceDropdown();
            } else {
                container.classList.add('hidden');
                btns.classList.remove('hidden');
                clearPatientForm(false);
            }
        }

        // Altersberechnung
        document.getElementById('patientGeburtsdatum').addEventListener('change', function() {
            const dobValue = this.value;
            if (!dobValue) {
                document.getElementById('patientAlter').value = '';
                return;
            }
            
            const dob = new Date(dobValue);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            
            if (age >= 0) {
                document.getElementById('patientAlter').value = age;
            }
        });

        // Kategorie ausw√§hlen
        function selectKategorie(kategorie) {
            document.querySelectorAll('.btn-kategorie').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.btn-kategorie').classList.add('active');
            selectedKategorie = kategorie;
            document.getElementById('patientKategorie').value = kategorie;
        }

        // Sichtung ausw√§hlen
        function selectSichtung(category) {
            document.querySelectorAll('.btn-sichtung-compact').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.btn-sichtung-compact').classList.add('active');
            selectedSichtung = category;
            document.getElementById('patientSichtung').value = category;
        }

        // Geschlecht ausw√§hlen
        function selectGender(gender) {
            document.querySelectorAll('.btn-gender').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            selectedGender = gender;
            document.getElementById('patientGeschlecht').value = gender;
        }

        // Verletztenstatus togglen
        function toggleVerletztenstatus(status) {
            const btn = event.target.closest('.btn-verletztenstatus');
            btn.classList.toggle('active');
            
            const index = selectedVerletztenstatus.indexOf(status);
            if (index > -1) {
                selectedVerletztenstatus.splice(index, 1);
            } else {
                selectedVerletztenstatus.push(status);
            }
            
            document.getElementById('patientVerletztenstatus').value = selectedVerletztenstatus.join(',');
        }

        // Vitalwerte hinzuf√ºgen
        function addVitalwert(type) {
            const now = new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
            let value;

            switch(type) {
                case 'bz':
                    value = document.getElementById('inputBZ').value;
                    if (!value) return;
                    currentVitalwerte.bz.push({time: now, value: parseFloat(value)});
                    document.getElementById('inputBZ').value = '';
                    renderVitalHistory('bz', 'bzHistory', 'mg/dl');
                    break;
                case 'rr':
                    const sys = document.getElementById('inputRRSys').value;
                    const dia = document.getElementById('inputRRDia').value;
                    if (!sys || !dia) return;
                    currentVitalwerte.rr.push({time: now, sys: parseFloat(sys), dia: parseFloat(dia)});
                    document.getElementById('inputRRSys').value = '';
                    document.getElementById('inputRRDia').value = '';
                    renderVitalHistory('rr', 'rrHistory', 'mmHg');
                    break;
                case 'puls':
                    value = document.getElementById('inputPuls').value;
                    if (!value) return;
                    currentVitalwerte.puls.push({time: now, value: parseFloat(value)});
                    document.getElementById('inputPuls').value = '';
                    renderVitalHistory('puls', 'pulsHistory', '/min');
                    break;
                case 'spo2':
                    value = document.getElementById('inputSpO2').value;
                    if (!value) return;
                    currentVitalwerte.spo2.push({time: now, value: parseFloat(value)});
                    document.getElementById('inputSpO2').value = '';
                    renderVitalHistory('spo2', 'spo2History', '%');
                    break;
            }
        }

        function renderVitalHistory(type, containerId, unit) {
            const container = document.getElementById(containerId);
            const data = currentVitalwerte[type];
            
            if (data.length === 0) {
                container.innerHTML = '';
                return;
            }

            const recentData = data.slice(-3).reverse();

            container.innerHTML = recentData.map((entry, index) => {
                let displayValue;
                if (type === 'rr') {
                    displayValue = `${entry.sys}/${entry.dia} ${unit}`;
                } else {
                    displayValue = `${entry.value} ${unit}`;
                }
                const realIndex = data.length - 1 - index;
                return `
                    <div class="vital-entry">
                        <span class="vital-entry-time">${entry.time}</span>
                        <span class="vital-entry-value">${displayValue}</span>
                        <button type="button" class="btn-delete-vital" onclick="deleteVitalwert('${type}', ${realIndex})">√ó</button>
                    </div>
                `;
            }).join('');
        }

        function deleteVitalwert(type, index) {
            currentVitalwerte[type].splice(index, 1);
            const containerMap = { 'bz': 'bzHistory', 'rr': 'rrHistory', 'puls': 'pulsHistory', 'spo2': 'spo2History' };
            const unitMap = { 'bz': 'mg/dl', 'rr': 'mmHg', 'puls': '/min', 'spo2': '%' };
            renderVitalHistory(type, containerMap[type], unitMap[type]);
        }

        // Patienten-Form Submit
        document.getElementById('patientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (editingPatientId) {
                updatePatient();
            } else {
                addPatient();
            }
        });

        function addPatient() {
            const nachname = document.getElementById('patientNachname').value;
            const diagnose = document.getElementById('patientDiagnose').value;
            const patientOrt = document.getElementById('patientOrt').value;

            if (!nachname || !diagnose || !patientOrt) {
                alert("Bitte f√ºllen Sie alle Pflichtfelder (Nachname, Ort, Diagnose) aus.");
                return;
            }

            patientCounter++;
            
            const sichtung = isAmbulantEntry ? 'SK3' : document.getElementById('patientSichtung').value;
            const gesichtetDurch = document.getElementById('patientGesichtetDurch').value;
            const kategorie = document.getElementById('patientKategorie').value;
            
            let assignedResourceName = null;
            let transportInfo = null;
            let isTransported = false;

            if (!isAmbulantEntry && !isMCView) {
                assignedResourceName = document.getElementById('patientTransportResource').value;
                if (assignedResourceName) {
                    const resource = resources.find(r => r.name === assignedResourceName);
                    if (resource) {
                        setResourceStatus(resource.id, '3');
                        transportInfo = {
                            fahrzeug: assignedResourceName,
                            zielklinik: document.getElementById('patientTransportziel').value || 'Unbekannt',
                            zeitpunkt: new Date().toLocaleString('de-DE')
                        };
                        isTransported = true;
                    }
                }
            }

            // Adresse zusammenbauen
            const strasse = document.getElementById('patientStrasse').value;
            const hausnummer = document.getElementById('patientHausnummer').value;
            const plz = document.getElementById('patientPLZ').value;
            const wohnort = document.getElementById('patientWohnort').value;
            const adresseComplete = [strasse, hausnummer, plz, wohnort].filter(Boolean).join(', ');

            const patient = {
                id: Date.now(),
                nummer: patientCounter,
                kategorie: kategorie,
                sichtung: sichtung,
                gesichtetDurch: gesichtetDurch,
                patientOrt: patientOrt,
                sichtungsort: document.getElementById('patientSichtungsort').value,
                abschnitt: document.getElementById('patientAbschnitt').value,
                nachname: nachname,
                vorname: document.getElementById('patientVorname').value || '',
                alter: isAmbulantEntry ? '' : document.getElementById('patientAlter').value,
                geburtsdatum: isAmbulantEntry ? '' : document.getElementById('patientGeburtsdatum').value,
                geschlecht: document.getElementById('patientGeschlecht').value,
                telefon: isAmbulantEntry ? '' : document.getElementById('patientTelefon').value,
                strasse: isAmbulantEntry ? '' : strasse,
                hausnummer: isAmbulantEntry ? '' : hausnummer,
                plz: isAmbulantEntry ? '' : plz,
                wohnort: isAmbulantEntry ? '' : wohnort,
                adresse: isAmbulantEntry ? '' : adresseComplete,
                kontaktperson: isAmbulantEntry ? '' : document.getElementById('patientKontaktperson').value,
                allergien: isAmbulantEntry ? '' : document.getElementById('patientAllergien').value,
                airway: isAmbulantEntry ? '' : document.getElementById('patientAirway').value,
                breathing: isAmbulantEntry ? '' : document.getElementById('patientBreathing').value,
                circulation: isAmbulantEntry ? '' : document.getElementById('patientCirculation').value,
                disability: isAmbulantEntry ? '' : document.getElementById('patientDisability').value,
                exposure: isAmbulantEntry ? '' : document.getElementById('patientExposure').value,
                verletzungsbereich: isAmbulantEntry ? '' : document.getElementById('patientVerletzungsbereich').value,
                verletztenstatus: isAmbulantEntry ? [] : selectedVerletztenstatus.slice(),
                gcs: isAmbulantEntry ? '' : document.getElementById('patientGCS').value,
                schmerzskala: isAmbulantEntry ? '' : document.getElementById('patientSchmerzskala').value,
                pupillen: isAmbulantEntry ? '' : document.getElementById('patientPupillen').value,
                diagnose: diagnose,
                transportziel: isAmbulantEntry ? '' : document.getElementById('patientTransportziel').value,
                vitalwerte: isAmbulantEntry ? {bz:[], rr:[], puls:[], spo2:[]} : JSON.parse(JSON.stringify(currentVitalwerte)),
                aufnahmezeit: new Date().toLocaleString('de-DE'),
                transport: transportInfo,
                transportiert: isTransported,
                entlassen: isAmbulantEntry,
                entlassungzeit: isAmbulantEntry ? new Date().toLocaleString('de-DE') : null,
                isAmbulant: isAmbulantEntry
            };
            
            patients.push(patient);
            
            const entry = {
                id: ++entryCounter,
                date: new Date().toLocaleDateString('de-DE'),
                time: new Date().toLocaleTimeString('de-DE'),
                timestamp: new Date().toLocaleString('de-DE'),
                artMeldung: 'Patientenaufnahme',
                vorrangstufe: 'Einfach',
                absender: gesichtetDurch,
                funktion: currentUserFunction,
                fahrzeug: assignedResourceName || null,
                sichtung: sichtung,
                meldung: `Patient #${patientCounter} aufgenommen (${isAmbulantEntry ? 'Ambulant' : 'Regul√§r'}) - ${kategorie} - ${sichtung} - ${patient.abschnitt} - ${patient.sichtungsort} - Ort: ${patientOrt}${assignedResourceName ? ' - Ressource ' + assignedResourceName + ' zugewiesen' : ''}`
            };
            
            entries.unshift(entry);
            
            if (!absenderSet.has(gesichtetDurch)) {
                absenderSet.add(gesichtetDurch);
                updateAbsenderFilter();
            }
            
            renderPatients();
            renderEntries();
            renderMCLog();
            togglePatientForm(false);
        }

        function editPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            editingPatientId = patientId;
            
            const mode = patient.isAmbulant ? 'ambulant' : 'standard';
            togglePatientForm(true, mode);
            
            document.getElementById('formTitle').textContent = `Patient #${patient.nummer} bearbeiten`;
            document.getElementById('submitPatientBtn').textContent = '√Ñnderungen speichern';
            document.getElementById('editPatientId').value = patientId;

            document.getElementById('patientKategorie').value = patient.kategorie;
            document.querySelectorAll('.btn-kategorie').forEach(btn => {
                if (btn.textContent.includes(patient.kategorie)) btn.classList.add('active');
            });

            if (!patient.isAmbulant) {
                document.getElementById('patientSichtung').value = patient.sichtung;
                document.querySelectorAll('.btn-sichtung-compact').forEach(btn => {
                    if (btn.textContent.includes(patient.sichtung)) btn.classList.add('active');
                });
            }

            document.getElementById('patientGesichtetDurch').value = patient.gesichtetDurch;
            document.getElementById('patientOrt').value = patient.patientOrt;
            document.getElementById('patientSichtungsort').value = patient.sichtungsort;
            document.getElementById('patientAbschnitt').value = patient.abschnitt;
            document.getElementById('patientNachname').value = patient.nachname;
            document.getElementById('patientVorname').value = patient.vorname;
            
            if (!patient.isAmbulant) {
                document.getElementById('patientAlter').value = patient.alter;
                document.getElementById('patientGeburtsdatum').value = patient.geburtsdatum;
                document.getElementById('patientTelefon').value = patient.telefon || '';
                document.getElementById('patientStrasse').value = patient.strasse || '';
                document.getElementById('patientHausnummer').value = patient.hausnummer || '';
                document.getElementById('patientPLZ').value = patient.plz || '';
                document.getElementById('patientWohnort').value = patient.wohnort || '';
                document.getElementById('patientKontaktperson').value = patient.kontaktperson || '';
                document.getElementById('patientAllergien').value = patient.allergien || '';
                document.getElementById('patientVerletzungsbereich').value = patient.verletzungsbereich;
            }
            
            if (patient.geschlecht) {
                document.getElementById('patientGeschlecht').value = patient.geschlecht;
                document.querySelectorAll('.btn-gender').forEach(btn => {
                    const genderMap = {'üë®': 'm√§nnlich', 'üë©': 'weiblich', '‚öß': 'divers'};
                    if (genderMap[btn.textContent] === patient.geschlecht) btn.classList.add('active');
                });
            }

            document.getElementById('patientDiagnose').value = patient.diagnose;

            if (!patient.isAmbulant) {
                document.getElementById('patientAirway').value = patient.airway;
                document.getElementById('patientBreathing').value = patient.breathing;
                document.getElementById('patientCirculation').value = patient.circulation;
                document.getElementById('patientDisability').value = patient.disability;
                document.getElementById('patientExposure').value = patient.exposure;
                document.getElementById('patientGCS').value = patient.gcs;
                document.getElementById('patientSchmerzskala').value = patient.schmerzskala;
                document.getElementById('patientPupillen').value = patient.pupillen;
                document.getElementById('patientTransportziel').value = patient.transportziel;

                selectedVerletztenstatus = [...patient.verletztenstatus];
                document.querySelectorAll('.btn-verletztenstatus').forEach(btn => {
                    const classes = btn.className.split(' ');
                    const status = classes.find(c => c !== 'btn-verletztenstatus' && c !== 'active');
                    if (patient.verletztenstatus.includes(status)) btn.classList.add('active');
                });

                currentVitalwerte = JSON.parse(JSON.stringify(patient.vitalwerte));
                renderVitalHistory('bz', 'bzHistory', 'mg/dl');
                renderVitalHistory('rr', 'rrHistory', 'mmHg');
                renderVitalHistory('puls', 'pulsHistory', '/min');
                renderVitalHistory('spo2', 'spo2History', '%');
            }

            document.getElementById('patientFormContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function updatePatient() {
            const patient = patients.find(p => p.id === editingPatientId);
            if (!patient) return;

            const nachname = document.getElementById('patientNachname').value;
            const diagnose = document.getElementById('patientDiagnose').value;
            const patientOrt = document.getElementById('patientOrt').value;

            if (!nachname || !diagnose || !patientOrt) {
                alert("Bitte f√ºllen Sie alle Pflichtfelder aus.");
                return;
            }

            patient.kategorie = document.getElementById('patientKategorie').value;
            if (!patient.isAmbulant) {
                patient.sichtung = document.getElementById('patientSichtung').value;
            }
            patient.gesichtetDurch = document.getElementById('patientGesichtetDurch').value;
            patient.patientOrt = patientOrt;
            patient.sichtungsort = document.getElementById('patientSichtungsort').value;
            patient.abschnitt = document.getElementById('patientAbschnitt').value;
            patient.nachname = nachname;
            patient.vorname = document.getElementById('patientVorname').value || '';
            patient.geschlecht = document.getElementById('patientGeschlecht').value;
            patient.diagnose = diagnose;

            if (!patient.isAmbulant) {
                patient.alter = document.getElementById('patientAlter').value;
                patient.geburtsdatum = document.getElementById('patientGeburtsdatum').value;
                patient.telefon = document.getElementById('patientTelefon').value;
                patient.strasse = document.getElementById('patientStrasse').value;
                patient.hausnummer = document.getElementById('patientHausnummer').value;
                patient.plz = document.getElementById('patientPLZ').value;
                patient.wohnort = document.getElementById('patientWohnort').value;
                patient.kontaktperson = document.getElementById('patientKontaktperson').value;
                patient.adresse = [patient.strasse, patient.hausnummer, patient.plz, patient.wohnort].filter(Boolean).join(', ');
                patient.allergien = document.getElementById('patientAllergien').value;
                patient.verletzungsbereich = document.getElementById('patientVerletzungsbereich').value;
                patient.airway = document.getElementById('patientAirway').value;
                patient.breathing = document.getElementById('patientBreathing').value;
                patient.circulation = document.getElementById('patientCirculation').value;
                patient.disability = document.getElementById('patientDisability').value;
                patient.exposure = document.getElementById('patientExposure').value;
                patient.verletztenstatus = selectedVerletztenstatus.slice();
                patient.gcs = document.getElementById('patientGCS').value;
                patient.schmerzskala = document.getElementById('patientSchmerzskala').value;
                patient.pupillen = document.getElementById('patientPupillen').value;
                patient.transportziel = document.getElementById('patientTransportziel').value;
                patient.vitalwerte = JSON.parse(JSON.stringify(currentVitalwerte));
            }

            const entry = {
                id: ++entryCounter,
                date: new Date().toLocaleDateString('de-DE'),
                time: new Date().toLocaleTimeString('de-DE'),
                timestamp: new Date().toLocaleString('de-DE'),
                artMeldung: 'Ma√ünahme',
                vorrangstufe: 'Einfach',
                absender: patient.gesichtetDurch,
                funktion: currentUserFunction,
                fahrzeug: null,
                sichtung: patient.sichtung,
                meldung: `Patient #${patient.nummer} (${patient.nachname}) wurde aktualisiert`
            };
            
            entries.unshift(entry);

            renderPatients();
            renderEntries();
            renderMCLog();
            togglePatientForm(false);
        }

        function clearPatientForm(hide = true) {
            editingPatientId = null;
            document.getElementById('formTitle').textContent = 'Neuen Patienten aufnehmen';
            document.getElementById('submitPatientBtn').textContent = 'Speichern';
            document.getElementById('editPatientId').value = '';
            
            document.getElementById('patientForm').reset();
            document.querySelectorAll('.btn-sichtung-compact').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.btn-gender').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.btn-verletztenstatus').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.btn-kategorie').forEach(btn => btn.classList.remove('active'));
            selectedSichtung = null;
            selectedGender = null;
            selectedVerletztenstatus = [];
            selectedKategorie = null;

            currentVitalwerte = { bz: [], rr: [], puls: [], spo2: [] };
            document.getElementById('bzHistory').innerHTML = '';
            document.getElementById('rrHistory').innerHTML = '';
            document.getElementById('pulsHistory').innerHTML = '';
            document.getElementById('spo2History').innerHTML = '';
        }

        function filterPatients(filter) {
            currentPatientFilter = filter;
            document.querySelectorAll('.patient-filter-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderPatients();
        }

        function renderPatients() {
            const container = document.getElementById('patientsContainer');
            
            let filteredPatients = patients;
            if (currentPatientFilter === 'aktuell') {
                filteredPatients = patients.filter(p => !p.entlassen && !p.isAmbulant);
            } else if (currentPatientFilter === 'ambulant') {
                filteredPatients = patients.filter(p => p.isAmbulant);
            } else if (currentPatientFilter === 'entlassen') {
                filteredPatients = patients.filter(p => p.entlassen && !p.isAmbulant);
            } else if (currentPatientFilter === 'mc1') {
                filteredPatients = patients.filter(p => !p.entlassen && p.patientOrt === 'MC 1');
            } else if (currentPatientFilter === 'mc2') {
                filteredPatients = patients.filter(p => !p.entlassen && p.patientOrt === 'MC 2');
            }
            
            document.getElementById('patientCount').textContent = patients.length;
            
            if (filteredPatients.length === 0) {
                container.innerHTML = '<div class="empty-state">Keine Patienten in dieser Kategorie</div>';
                return;
            }
            
            // Transport-Button nur f√ºr Einsatzleitung/F√ºhrungsassistent anzeigen
            const showTransportButton = !isMCView;
            
            container.innerHTML = filteredPatients.map(patient => {
                const skClass = patient.sichtung.toLowerCase();
                const displayName = patient.vorname ? `${patient.vorname} ${patient.nachname}` : patient.nachname;
                
                return `
                    <div class="patient-card ${skClass} ${patient.entlassen ? 'entlassen' : ''} ${patient.isAmbulant ? 'ambulant' : ''}" onclick="editPatient(${patient.id})">
                        <div class="patient-header">
                            <span class="patient-number">#${String(patient.nummer).padStart(3, '0')}</span>
                            <span class="patient-sichtung ${skClass}">${patient.sichtung}</span>
                        </div>
                        
                        <div class="patient-compact-row">
                            <span class="patient-compact-label">Name:</span>
                            <span class="patient-compact-value">${displayName}</span>
                        </div>
                        <div class="patient-compact-row">
                            <span class="patient-compact-label">Kat / Alter:</span>
                            <span class="patient-compact-value">${patient.kategorie} ${patient.alter ? ' / ' + patient.alter + 'J' : ''}</span>
                        </div>
                        <div class="patient-compact-row">
                            <span class="patient-compact-label">Ort:</span>
                            <span class="patient-compact-value">${patient.patientOrt}</span>
                        </div>
                        <div class="patient-compact-row">
                            <span class="patient-compact-label">Diagnose:</span>
                            <span class="patient-compact-value">${patient.diagnose}</span>
                        </div>

                        ${!patient.entlassen && !patient.isAmbulant && !patient.transportiert && showTransportButton ? `
                            <button class="btn-transport" onclick="event.stopPropagation(); openTransportModal(${patient.id})">
                                <span class="icon">üöë</span>
                                <span>Transport</span>
                            </button>
                        ` : ''}
                        
                        ${!patient.entlassen && !patient.isAmbulant ? `
                             <button class="btn-edit-patient" style="background: var(--status-entlassen); color: white;" onclick="event.stopPropagation(); entlassenPatient(${patient.id})">
                                Entlassen
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function entlassenPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            patient.entlassen = true;
            patient.entlassungzeit = new Date().toLocaleString('de-DE');
            
            const entry = {
                id: ++entryCounter,
                date: new Date().toLocaleDateString('de-DE'),
                time: new Date().toLocaleTimeString('de-DE'),
                timestamp: new Date().toLocaleString('de-DE'),
                artMeldung: 'Entlassung',
                vorrangstufe: 'Einfach',
                absender: patient.gesichtetDurch,
                funktion: currentUserFunction,
                fahrzeug: null,
                sichtung: patient.sichtung,
                meldung: `Patient #${patient.nummer} (${patient.nachname}) wurde entlassen`
            };
            
            entries.unshift(entry);
            renderPatients();
            renderEntries();
            renderMCLog();
        }

        function openTransportModal(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            document.getElementById('transportPatientId').value = patientId;
            if (patient.transportziel) document.getElementById('transportZielklinik').value = patient.transportziel;
            
            const select = document.getElementById('transportFahrzeug');
            select.innerHTML = '<option value="">-- Ausw√§hlen --</option>';
            
            resources.forEach(resource => {
                if (resource.status === '1') {
                    select.innerHTML += `<option value="${resource.name}">${resource.name} (${resource.type})</option>`;
                }
            });
            
            document.getElementById('transportModal').classList.add('active');
        }

        function closeTransportModal() {
            document.getElementById('transportModal').classList.remove('active');
            document.getElementById('transportForm').reset();
        }

        document.getElementById('transportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const patientId = parseInt(document.getElementById('transportPatientId').value);
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const fahrzeug = document.getElementById('transportFahrzeug').value;
            const zielklinik = document.getElementById('transportZielklinik').value;
            
            patient.transport = { fahrzeug: fahrzeug, zielklinik: zielklinik, zeitpunkt: new Date().toLocaleString('de-DE') };
            patient.transportiert = true;
            
            const entry = {
                id: ++entryCounter,
                date: new Date().toLocaleDateString('de-DE'),
                time: new Date().toLocaleTimeString('de-DE'),
                timestamp: new Date().toLocaleString('de-DE'),
                artMeldung: 'Transport',
                vorrangstufe: 'Einfach',
                absender: patient.gesichtetDurch,
                funktion: currentUserFunction,
                fahrzeug: fahrzeug,
                sichtung: patient.sichtung,
                meldung: `Patient #${patient.nummer} (${patient.nachname}) wird mit ${fahrzeug} nach ${zielklinik} transportiert`
            };
            
            entries.unshift(entry);
            
            if (!fahrzeugSet.has(fahrzeug)) {
                fahrzeugSet.add(fahrzeug);
                updateFahrzeugFilter();
            }

            const resource = resources.find(r => r.name === fahrzeug);
            if (resource) setResourceStatus(resource.id, '3');
            
            renderPatients();
            renderEntries();
            renderMCLog();
            closeTransportModal();
        });

        // Ressourcen-Verwaltung
        function addResource() {
            const type = document.getElementById('newResourceType').value;
            const name = document.getElementById('newResourceName').value.trim();
            
            if (!name) { alert('Bitte geben Sie ein Kennzeichen / Namen ein'); return; }
            
            const resource = { id: Date.now(), type: type, name: name, status: null };
            resources.push(resource);
            document.getElementById('newResourceName').value = '';
            renderResources();
            updateResourceDropdown();
        }

        function deleteResource(id) {
            resources = resources.filter(r => r.id !== id);
            renderResources();
            updateFahrzeugFilter();
            updateResourceDropdown();
        }

        function updateResourceDropdown() {
            const select = document.getElementById('patientTransportResource');
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Keine Zuweisung --</option>';
            resources.forEach(resource => {
                if (resource.status === '1') {
                    select.innerHTML += `<option value="${resource.name}">${resource.name} (${resource.type})</option>`;
                }
            });
            if ([...select.options].some(o => o.value === currentValue)) {
                select.value = currentValue;
            }
        }

        function setResourceStatus(resourceId, status) {
            const resource = resources.find(r => r.id === resourceId);
            if (!resource) return;
            
            resource.status = status;
            const absender = document.getElementById('absender').value;
            const statusText = statusTexts[status];
            
            const entry = {
                id: ++entryCounter,
                date: new Date().toLocaleDateString('de-DE'),
                time: new Date().toLocaleTimeString('de-DE'),
                timestamp: new Date().toLocaleString('de-DE'),
                artMeldung: 'Funkspruch',
                vorrangstufe: 'Einfach',
                absender: absender,
                funktion: currentUserFunction,
                fahrzeug: resource.name,
                meldung: `${resource.name} Status ${status} - ${statusText}`
            };
            
            entries.unshift(entry);
            if (!absenderSet.has(absender)) { absenderSet.add(absender); updateAbsenderFilter(); }
            if (!fahrzeugSet.has(resource.name)) { fahrzeugSet.add(resource.name); updateFahrzeugFilter(); }
            
            renderResources();
            renderEntries();
            renderMCLog();
            updateResourceDropdown();
        }

        function renderResources() {
            const container = document.getElementById('resourcesContainer');
            if (resources.length === 0) { container.innerHTML = '<div class="empty-state">Noch keine Ressourcen angelegt</div>'; return; }
            
            const grouped = resources.reduce((acc, resource) => {
                if (!acc[resource.type]) acc[resource.type] = [];
                acc[resource.type].push(resource);
                return acc;
            }, {});
            
            const types = ['KTW', 'RTW', 'NEF', 'NAW', 'Sonstiges'];
            let html = '';
            types.forEach(type => {
                if (grouped[type] && grouped[type].length > 0) {
                    html += `<div class="resource-type-section"><div class="resource-type-header ${type.toLowerCase()}"><span class="resource-icon">${vehicleIcons[type]}</span><span>${type} (${grouped[type].length})</span></div><div class="resources-grid">`;
                    grouped[type].forEach(resource => {
                        html += `<div class="resource-card ${type.toLowerCase()}"><div class="resource-header"><div class="resource-name">${resource.name}</div><button class="btn-delete-resource" onclick="deleteResource(${resource.id})" title="L√∂schen">√ó</button></div><div class="resource-status">Status: ${resource.status ? `<span class="current-status status-${resource.status}">${resource.status} - ${statusTexts[resource.status]}</span>` : '<span style="color: var(--text-tertiary); font-size: 10px;">Kein Status</span>'}</div><div class="status-buttons"><button class="btn-status status-1" onclick="setResourceStatus(${resource.id}, '1')">1</button><button class="btn-status status-3" onclick="setResourceStatus(${resource.id}, '3')">3</button><button class="btn-status status-4" onclick="setResourceStatus(${resource.id}, '4')">4</button><button class="btn-status status-7" onclick="setResourceStatus(${resource.id}, '7')">7</button><button class="btn-status status-8" onclick="setResourceStatus(${resource.id}, '8')">8</button></div></div>`;
                    });
                    html += `</div></div>`;
                }
            });
            container.innerHTML = html;
        }

        function insertMessage(selectElement) {
            const textarea = document.getElementById('meldung');
            if (selectElement.value) { textarea.value = selectElement.value; selectElement.selectedIndex = 0; }
        }

        document.getElementById('einsatzForm').addEventListener('submit', function(e) { e.preventDefault(); addLogEntry(); });

        function addLogEntry() {
            entryCounter++;
            const now = new Date();
            const absender = document.getElementById('absender').value;
            const entry = {
                id: entryCounter,
                date: now.toLocaleDateString('de-DE'),
                time: now.toLocaleTimeString('de-DE'),
                timestamp: now.toLocaleString('de-DE'),
                artMeldung: document.getElementById('artMeldung').value,
                vorrangstufe: document.getElementById('vorrangstufe').value,
                absender: absender,
                funktion: currentUserFunction,
                fahrzeug: null,
                meldung: document.getElementById('meldung').value
            };
            entries.unshift(entry);
            if (!absenderSet.has(absender)) { absenderSet.add(absender); updateAbsenderFilter(); }
            renderEntries();
            renderMCLog();
            clearForm();
        }

        function updateAbsenderFilter() {
            const filterAbsender = document.getElementById('filterAbsender');
            const currentValue = filterAbsender.value;
            filterAbsender.innerHTML = '<option value="">Alle</option>';
            Array.from(absenderSet).sort().forEach(absender => {
                const option = document.createElement('option'); option.value = absender; option.textContent = absender; filterAbsender.appendChild(option);
            });
            filterAbsender.value = currentValue;
        }

        function updateFahrzeugFilter() {
            const filterFahrzeug = document.getElementById('filterFahrzeug');
            const currentValue = filterFahrzeug.value;
            filterFahrzeug.innerHTML = '<option value="">Alle</option>';
            const fahrzeugeInEintraegen = new Set();
            entries.forEach(entry => { if (entry.fahrzeug) fahrzeugeInEintraegen.add(entry.fahrzeug); });
            Array.from(fahrzeugeInEintraegen).sort().forEach(fahrzeug => {
                const option = document.createElement('option'); option.value = fahrzeug; option.textContent = fahrzeug; filterFahrzeug.appendChild(option);
            });
            filterFahrzeug.value = currentValue;
        }

        function renderEntries() {
            const container = document.getElementById('logEntries');
            if (entries.length === 0) {
                container.innerHTML = '<div class="empty-state">Noch keine Eintr√§ge vorhanden</div>';
                document.getElementById('entryCount').textContent = '0'; document.getElementById('totalCount').textContent = '0';
                return;
            }
            container.innerHTML = entries.map(entry => {
                const priorityClass = entry.vorrangstufe.toLowerCase();
                const isPatientEntry = entry.artMeldung === 'Patientenaufnahme' || entry.artMeldung === 'Transport';
                const isEntlassenEntry = entry.artMeldung === 'Entlassung';
                const hasSichtung = entry.sichtung;
                let classes = `log-entry ${priorityClass !== 'einfach' ? 'priority-' + priorityClass : ''}`;
                if (isPatientEntry && hasSichtung) classes += ` patient-entry ${entry.sichtung.toLowerCase()}`;
                if (isEntlassenEntry) classes += ' entlassen-entry';
                
                return `<div class="${classes}" data-art="${entry.artMeldung}" data-vorrang="${entry.vorrangstufe}" data-absender="${entry.absender}" data-fahrzeug="${entry.fahrzeug || ''}"><div class="log-meta"><span class="log-number">#${String(entry.id).padStart(3, '0')}</span><span class="log-time">${entry.date} ${entry.time}</span><span>${entry.artMeldung}</span>${entry.funktion ? `<span class="log-function">[${entry.funktion}]</span>` : ''}<span class="priority-badge priority-${priorityClass}">${entry.vorrangstufe}</span>${hasSichtung ? `<span class="sichtung-badge ${entry.sichtung.toLowerCase()}">${entry.sichtung}</span>` : ''}</div><div class="log-content"><div class="log-label">Absender:</div><div class="log-value">${entry.absender}</div></div><div class="log-message"><div class="log-label">Meldung:</div><div class="log-value">${entry.meldung}</div></div></div>`;
            }).join('');
            document.getElementById('totalCount').textContent = entries.length;
            updateFahrzeugFilter();
            applyFilters();
        }

        // MC Log (nur lesen)
        function renderMCLog() {
            const container = document.getElementById('mcLogEntries');
            if (entries.length === 0) {
                container.innerHTML = '<div class="empty-state">Noch keine Eintr√§ge vorhanden</div>';
                return;
            }
            container.innerHTML = entries.slice(0, 20).map(entry => {
                const priorityClass = entry.vorrangstufe.toLowerCase();
                return `<div class="log-entry ${priorityClass !== 'einfach' ? 'priority-' + priorityClass : ''}"><div class="log-meta"><span class="log-number">#${String(entry.id).padStart(3, '0')}</span><span class="log-time">${entry.date} ${entry.time}</span><span>${entry.artMeldung}</span>${entry.funktion ? `<span class="log-function">[${entry.funktion}]</span>` : ''}</div><div class="log-message"><div class="log-value">${entry.meldung}</div></div></div>`;
            }).join('');
        }

        function applyFilters() {
            const filterArt = document.getElementById('filterArt').value;
            const filterVorrang = document.getElementById('filterVorrang').value;
            const filterAbsender = document.getElementById('filterAbsender').value;
            const filterFahrzeug = document.getElementById('filterFahrzeug').value;
            
            const allEntries = document.querySelectorAll('#logEntries .log-entry');
            let visibleCount = 0;
            
            allEntries.forEach(entry => {
                const art = entry.dataset.art;
                const vorrang = entry.dataset.vorrang;
                const absender = entry.dataset.absender;
                const fahrzeug = entry.dataset.fahrzeug;
                
                const artMatch = !filterArt || art === filterArt;
                const vorrangMatch = !filterVorrang || vorrang === filterVorrang;
                const absenderMatch = !filterAbsender || absender === filterAbsender;
                const fahrzeugMatch = !filterFahrzeug || fahrzeug === filterFahrzeug;
                
                if (artMatch && vorrangMatch && absenderMatch && fahrzeugMatch) {
                    entry.classList.remove('hidden'); visibleCount++;
                } else {
                    entry.classList.add('hidden');
                }
            });
            
            document.getElementById('entryCount').textContent = visibleCount;
        }

        function resetFilters() {
            document.getElementById('filterArt').value = '';
            document.getElementById('filterVorrang').value = '';
            document.getElementById('filterAbsender').value = '';
            document.getElementById('filterFahrzeug').value = '';
            applyFilters();
        }

        function clearForm() {
            document.getElementById('einsatzForm').reset();
            document.querySelectorAll('.standard-messages-grid select').forEach(select => { select.selectedIndex = 0; });
            document.getElementById('artMeldung').value = 'Funkspruch';
            document.getElementById('vorrangstufe').value = 'Einfach';
            document.getElementById('absender').value = 'F√ºASs';
            document.getElementById('funktion').value = currentUserFunction || '';
        }

        // CSV Export f√ºr Meldungen
        function exportMeldungenCSV() {
            if (entries.length === 0) { 
                alert('Keine Meldungen zum Exportieren vorhanden'); 
                return; 
            }
            
            const headers = ['Nummer', 'Zeit', 'Funkspruch', 'Absender', 'Meldung'];
            const rows = entries.map(entry => {
                return [
                    entry.id,
                    `${entry.date} ${entry.time}`,
                    entry.artMeldung,
                    entry.absender,
                    `"${entry.meldung.replace(/"/g, '""')}"`
                ].join(';');
            });
            
            const csvContent = '\uFEFF' + headers.join(';') + '\n' + rows.join('\n');
            const dataBlob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url; 
            link.download = `meldungen_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link); 
            URL.revokeObjectURL(url);
        }

        // CSV Export f√ºr Patienten (ALLE - inkl. entlassen und ambulant)
        function exportPatientenCSV() {
            if (patients.length === 0) { 
                alert('Keine Patienten zum Exportieren vorhanden'); 
                return; 
            }
            
            const headers = ['Nummer', 'Name', 'Vorname', 'Alter', 'Geschlecht', 'Sichtung', 'Kategorie', 'Abschnitt', 'Sichtungsort', 'Ort', 'Diagnose', 'Status', 'Aufnahme', 'Entlassung', 'Transport', 'Zielklinik', 'Typ', 'Telefon', 'Adresse'];
            const rows = patients.map(p => {
                const status = p.entlassen ? 'Entlassen' : (p.transportiert ? 'Transportiert' : 'Aktiv');
                const typ = p.isAmbulant ? 'Ambulant' : 'Regul√§r';
                return [
                    p.nummer,
                    `"${p.nachname}"`,
                    `"${p.vorname}"`,
                    p.alter || '',
                    p.geschlecht || '',
                    p.sichtung,
                    p.kategorie,
                    p.abschnitt,
                    `"${p.sichtungsort}"`,
                    `"${p.patientOrt}"`,
                    `"${p.diagnose.replace(/"/g, '""')}"`,
                    status,
                    p.aufnahmezeit,
                    p.entlassungzeit || '',
                    p.transport ? p.transport.fahrzeug : '',
                    p.transport ? p.transport.zielklinik : '',
                    typ,
                    p.telefon || '',
                    `"${p.adresse || ''}"`
                ].join(';');
            });
            
            const csvContent = '\uFEFF' + headers.join(';') + '\n' + rows.join('\n');
            const dataBlob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url; 
            link.download = `patienten_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link); 
            URL.revokeObjectURL(url);
        }

        window.onclick = function(event) {
            const transportModal = document.getElementById('transportModal');
            const endMissionModal = document.getElementById('endMissionModal');
            if (event.target === transportModal) closeTransportModal();
            if (event.target === endMissionModal) closeEndMissionModal();
        }
    </script>
</body>
</html>
